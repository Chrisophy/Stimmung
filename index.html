<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="./manifest.json">
    <title>Stimmungs-Tagebuch</title>
    <script src="tailwind.css"></script> 
    <style>

@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/1.woff2) format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/2.woff2) format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/3.woff2) format('woff2');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/4.woff2) format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/5.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/6.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 100 900;
  font-display: swap;
  src: url(./fonts/7.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

    	
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .mood-icon { font-size: 2.5rem; line-height: 1; transition: transform 0.2s, box-shadow 0.2s; }
        .mood-icon:hover { transform: scale(1.1); }
        .selected-mood { transform: scale(1.2) !important; box-shadow: 0 0 0 4px #4f46e5; border-radius: 9999px; padding: 4px; }
        .period-button { transition: background-color 0.2s, transform 0.1s; }
        .period-button:active { transform: scale(0.98); }
        .selected-period { background-color: #4f46e5 !important; color: white !important; font-weight: 600; }
        .pain-button.selected-pain { transform: scale(1.1) !important; box-shadow: 0 0 0 3px #9333ea; font-weight: 700; background-color: #9333ea !important; color: white !important; border-color: #9333ea !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 90%; width: 500px; margin: 2rem 0; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-show { display: flex; }
        /* NEUES CSS F√úR DIE EINTRAGSHISTORIE */
        .history-entry-item { 
            position: relative; /* Wichtig f√ºr die Positionierung des L√∂sch-Buttons */
            padding-right: 3rem; /* Platz f√ºr den L√∂sch-Button */
        }
        .delete-entry-btn { 
            position: absolute; 
            top: 0.5rem; 
            right: 0.5rem; 
            color: #f87171; 
            font-size: 1.5rem; 
            padding: 0.1rem 0.5rem; 
            line-height: 1; 
            transition: color 0.1s, transform 0.1s; 
            z-index: 10;
        }
        .delete-entry-btn:hover { color: #ef4444; transform: scale(1.1); }
        .stat-card { padding: 1rem; border-radius: 0.5rem; background-color: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; }
        .stat-card-title { font-size: 0.875rem; font-weight: 500; color: #6b7280; }
        .stat-card-value { font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem; }

        /* NEUES CSS F√úR DEN SCROLL-BUTTON */
        .scroll-to-top {
            position: fixed; /* Fixiert die Position */
            bottom: 20px;    /* 20px vom unteren Rand */
            right: 20px;     /* 20px vom rechten Rand */
            z-index: 1001;   /* √úber allen anderen Elementen */
            background-color: rgba(255,255,255,0.2)
            color: white;
            padding: 0.5rem;
            border-radius: 9px; /* Macht den Button kreisf√∂rmig */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s, transform 0.1s;
            display: none; /* Standardm√§√üig versteckt, wird per JS eingeblendet */
        }
        .scroll-to-top:hover {
            background-color: rgba(255,255,255,0.2);
        }
        .scroll-to-top:active {
            transform: scale(0.55);
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-6 max-w-lg mx-auto bg-white shadow-xl">
    <header class="text-center mb-6 pt-4">
        <h1 class="text-3xl font-extrabold text-indigo-700">Dein pers√∂nliches Stimmungs-Tagebuch</h1>
        <p class="text-gray-500 mt-1">Wie geht es Dir?</p>
        <p id="weather-status" class="text-center text-sm text-gray-400 mt-2">Lade Standort...</p> 
    </header>

    <section class="p-4 bg-yellow-50 rounded-xl shadow-md mb-8 border border-yellow-200">
        <h2 class="text-xl font-semibold mb-3 text-gray-800 flex justify-between items-center">
            Aktiver Benutzer: <span id="current-user-display" class="font-bold text-indigo-600 text-2xl">Lade...</span>
        </h2>
        <button id="manage-users-btn" class="w-full bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
            üßë‚Äçü§ù‚Äçüßë Benutzer verwalten / wechseln
        </button>
        <p id="status-message" class="mt-3 text-center text-sm font-medium h-4"></p>
        <a href="#verwaltung-section" class="block w-full text-center bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm mb-4">
         Zur Verwaltung
    </a>                
    </section>
    <section class="p-6 bg-gray-50 rounded-xl shadow-inner mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Neuer Eintrag</h2>
        
        <div class="mb-6">
            <label for="entry-date" class="font-medium block mb-2">0. W√§hle das Datum:</label>
            <input type="date" id="entry-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </div>
        <div class="mb-6">
            <p class="font-medium mb-2">1. W√§hle die Tageszeit:</p>
            <div id="time-periods" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button class="period-button bg-white text-indigo-600 border border-indigo-300 rounded-lg p-3 text-center shadow-sm" data-period="Nacht">
                    üåô Nacht
                </button>
                <button class="period-button bg-white text-indigo-600 border border-indigo-300 rounded-lg p-3 text-center shadow-sm" data-period="Morgen">
                    üåÖ Morgen
                </button>
                <button class="period-button bg-white text-indigo-600 border border-indigo-300 rounded-lg p-3 text-center shadow-sm" data-period="Mittag">
                    ‚òÄÔ∏è Mittag
                </button>
                <button class="period-button bg-white text-indigo-600 border border-indigo-300 rounded-lg p-3 text-center shadow-sm" data-period="Abend">
                    üåá Abend
                </button>
                </div>
        </div>

        <div class="mb-6">
            <p class="font-medium mb-2">2. W√§hle deine Stimmung:</p>
            <div id="mood-selection" class="flex justify-around items-center space-x-2">
                <div class="mood-icon cursor-pointer" data-mood="sehr_gut" title="Sehr gut">üòÄ</div>
                <div class="mood-icon cursor-pointer" data-mood="gut" title="Gut">üôÇ</div>
                <div class="mood-icon cursor-pointer" data-mood="neutral" title="Neutral">üòê</div>
                <div class="mood-icon cursor-pointer" data-mood="schlecht" title="Schlecht">üôÅ</div>
                <div class="mood-icon cursor-pointer" data-mood="sehr_schlecht" title="Sehr schlecht">üòû</div>
            </div>
        </div>
        
        <div class="mb-6">
            <p class="font-medium mb-2">3. Schmerzintensit√§t (0-10):</p>
            <div id="pain-selection" class="flex flex-wrap justify-center sm:justify-between gap-1">
                </div>
        </div>

        <div class="mb-6">
            <p class="font-medium mb-2">4. Schmerzregionen (Mehrfachauswahl m√∂glich):</p>
            <fieldset id="pain-regions" class="space-y-2 p-3 border border-gray-300 rounded-lg">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="schmerzregion" value="oben" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-gray-700">Oben (Kopf, Nacken, Schultern)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="schmerzregion" value="mitte" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-gray-700">Mitte (R√ºcken, Brustkorb, Bauch)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" name="schmerzregion" value="unten" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-gray-700">Unten (H√ºfte, Beine, F√º√üe)</span>
                </label>
            </fieldset>
        </div>

        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="font-medium mb-3 text-gray-700">5. Vitalfunktionen (optional):</p>
            <div class="space-y-3">
                
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="geburtsdatum" class="block text-xs font-medium text-gray-500">Geburtsdatum</label>
                        <input type="date" id="geburtsdatum" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex-1">
                        <label for="koerpergroesse" class="block text-xs font-medium text-gray-500">K√∂rpergr√∂√üe (cm)</label>
                        <input type="number" id="koerpergroesse" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="z.B. 175" min="50" step="1">
                    </div>
                </div>

                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="gewicht" class="block text-xs font-medium text-gray-500">Gewicht (kg)</label>
                        <input type="number" id="gewicht" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="z.B. 75.5" step="0.1" min="10">
                    </div>
                    <div class="flex-1">
                        <label for="bmi-display" class="block text-xs font-medium text-gray-500">BMI</label>
                        <input type="text" id="bmi-display" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-center font-bold" value="N/A" readonly>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="puls" class="block text-xs font-medium text-gray-500">Puls (BPM)</label>
                        <input type="number" id="puls" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="z.B. 65" min="20">
                    </div>
                    <div class="flex-1">
                        <label for="blutzucker" class="block text-xs font-medium text-gray-500">Blutzucker (mg/dL)</label>
                        <input type="number" id="blutzucker" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="z.B. 120" min="20">
                    </div>
                </div>
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <label for="blutdruck" class="block text-xs font-medium text-gray-500">Blutdruck (Sys/Dia)</label>
                        <div class="flex space-space-x-1">
                            <input type="number" id="blutdruckSys" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Sys" min="50">
                            <input type="number" id="blutdruckDia" class="w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" placeholder="Dia" min="30">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label for="note" class="font-medium block mb-2">6. Notizen (optional):</label>
            <textarea id="note" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Was war heute wichtig oder wie f√ºhlst du dich genauer?"></textarea>
        </div>

        <button id="save-entry" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md disabled:opacity-50" disabled>
            Bitte Datum, Zeitraum, Stimmung und Schmerz w√§hlen
        </button>
    </section>
    
    <section class="mt-8 mb-8 p-6 bg-gray-50 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">üìà Stimmungs-, Schmerz- & Wetterverlauf</h2>
        
        <div id="chart-container" class="relative h-64 w-full overflow-x-auto"> 
            <canvas id="moodChart" style="min-width: 300px;"></canvas>
            <p id="chart-status" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">
                Nicht gen√ºgend Daten f√ºr ein Diagramm (min. 2 Tage).
            </p>
        </div>
        
        <button id="export-chart-button" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-150 shadow-md mt-4">
            üñºÔ∏è Stimmungs-Chart speichern oder drucken
        </button>

        <div class="mt-4 text-sm text-center flex justify-center flex-wrap gap-x-4 gap-y-2">
            <p class="inline-block px-2 py-1 rounded-md bg-indigo-100 text-indigo-800 font-medium">Stimmung (Links: 1-5)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-purple-100 text-purple-800 font-medium">Schmerz (Rechts: 0-10)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-red-100 text-red-800 font-medium">Temperatur (Rechts: -5¬∞C bis 25¬∞C)</p>
        </div>
    </section>

    <section class="mt-8 mb-8 p-6 bg-gray-50 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">üíñ Vitalfunktionen-Verlauf</h2>
        
        <div id="vital-chart-container" class="relative h-64 w-full overflow-x-auto"> 
            <canvas id="vitalChart" style="min-width: 300px;"></canvas>
            <p id="vital-chart-status" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">
                Nicht gen√ºgend Daten f√ºr dieses Diagramm (min. 1 Eintrag mit Vitaldaten).
            </p>
        </div>

        <button id="export-vital-chart-button" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-150 shadow-md mt-4">
            üñºÔ∏è Vital-Chart speichern oder drucken
        </button>

        <div class="mt-4 text-sm text-center flex justify-center flex-wrap gap-x-4 gap-y-2">
            <p class="inline-block px-2 py-1 rounded-md bg-green-100 text-green-800 font-medium">Puls (BPM)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-blue-100 text-blue-800 font-medium">Blutdruck (mmHg)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-yellow-100 text-yellow-800 font-medium">Blutzucker (mg/dL)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-pink-100 text-pink-800 font-medium">Gewicht (kg)</p>
            <p class="inline-block px-2 py-1 rounded-md bg-indigo-100 text-indigo-800 font-medium">BMI</p>
        </div>
    </section>

    <section class="mt-8 mb-8 p-6 bg-gray-50 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">üìç H√§ufigkeit der Schmerzregionen</h2>
        <p class="text-sm text-gray-500 mb-4">Dieses Diagramm zeigt, welche Schmerzregionen am h√§ufigsten erfasst wurden.</p>
        
        <div id="pain-chart-container" class="relative h-64 w-full flex justify-center items-center"> 
            <canvas id="painRegionChart"></canvas>
            <p id="pain-chart-status" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">
                Nicht gen√ºgend Daten f√ºr dieses Diagramm (min. 1 Eintrag mit Schmerzregion).
            </p>
        </div>

        <button id="export-pain-chart-button" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-150 shadow-md mt-4">
            üñºÔ∏è Regionen-Diagramm speichern oder drucken
        </button>
    </section>
    
    <section>
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Deine Historie</h2>
        
        <div class="mb-4 flex space-x-3">
             <div class="flex-1">
                <label for="year-filter" class="sr-only">Jahr w√§hlen</label>
                <select id="year-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="all">Alle Jahre</option>
                    </select>
             </div>
             <div class="flex-1">
                <label for="month-filter" class="sr-only">Monat w√§hlen</label>
                <select id="month-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" disabled>
                    <option value="all">Alle Monate</option>
                    </select>
             </div>
        </div>
        
        <div id="stats-container" class="grid grid-cols-3 gap-2 mb-6">
            </div>
        <p id="loading-history" class="text-center text-gray-500 mt-8">Lade Eintr√§ge...</p>
        <div id="history-container">
            </div>
        <p id="no-entries" class="text-center text-gray-500 py-10 hidden">Noch keine Eintr√§ge vorhanden. Starte jetzt!</p>
    </section>
    
    <section id="verwaltung-section" class="mt-8 mb-4">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">Verwaltung</h2>
        
        <button id="help-button" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition duration-150 shadow-md mt-3">
            ‚ùì Hilfe / Funktions√ºbersicht
        </button>
        
        <div class="p-4 border border-blue-200 rounded-lg bg-blue-50 mb-4 mt-3">
            <h3 class="font-bold text-blue-800 mb-2">Daten-Import (Wiederherstellung)</h3>
            <label for="json-file-input" class="block font-medium mb-2 text-sm text-blue-700">1. JSON-Datei w√§hlen (Backup- oder Firebase-Export):</label>
            <input type="file" id="json-file-input" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
            <button id="import-data" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md mt-3 disabled:opacity-50" disabled>
                2. Daten aus Datei importieren und zusammenf√ºhren
            </button>
            <p id="import-status" class="mt-3 text-center text-sm font-medium h-4"></p>
        </div>
        
        <button id="export-data" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-150 shadow-md mt-3">
            üíæ Alle Daten als JSON exportieren (Backup erstellen)
        </button>

        <button id="reset-data" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-150 shadow-md disabled:opacity-50 mt-3">
            ‚ùå Alle Eintr√§ge l√∂schen (Neustart)
        </button>
        <p id="reset-status" class="mt-3 text-center text-sm font-medium h-4"></p>
    </section>

</div> 

<div id="help-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold p-1">
            &times;
        </button>
        <h2 class="text-2xl font-extrabold text-indigo-700 mb-4">Funktions√ºbersicht und Hilfe</h2>
        <div id="help-content" class="space-y-4 text-gray-700">
            <h3 class="text-xl font-bold text-gray-800 border-b pb-1">üéØ Hauptfunktion</h3>
            <p class="text-sm">
                Die Hauptfunktion der App ist die einfache und schnelle Erfassung und Nachverfolgung Ihres emotionalen und k√∂rperlichen Zustands √ºber den Tag und √ºber die Zeit.
            </p>
            
            <h3 class="text-xl font-bold text-gray-800 border-b pb-1">üßë‚Äçü§ù‚Äçüßë Mehrbenutzer-Modus</h3>
            <p class="text-sm">
                Die Anwendung unterst√ºtzt nun mehrere Benutzer. Alle Eintr√§ge und statischen Vitaldaten (Geburtsdatum, Gr√∂√üe) werden **lokal und getrennt** f√ºr jeden aktiven Benutzer gespeichert.
            </p>

            <h3 class="text-xl font-bold text-gray-800 border-b pb-1">üìù Erweiterte Erfassung</h3>
            <p class="font-semibold mt-2">Basis-Eintrag:</p>
            <p class="text-sm">
                Sie k√∂nnen zu einem w√§hlbaren Datum und verschiedenen Tageszeiten (Morgen, Mittag, Abend, Nacht) Ihre aktuelle Stimmung (Skala: sehr gut bis sehr schlecht) sowie die Schmerzintensit√§t (Skala 0-10) ausw√§hlen und optionale Notizen hinzuf√ºgen.
            </p>
            <p class="font-semibold mt-2">Schmerzregionen:</p>
            <p class="text-sm">
                Zus√§tzlich zur Intensit√§t k√∂nnen Sie nun die Schmerzregion(en) (Oben, Mitte, Unten) erfassen.
            </p>
            <p class="font-semibold mt-2">Vitalfunktionen:</p>
            <p class="text-sm">
                Optional k√∂nnen Puls, Gewicht, Blutzucker und Blutdruck (Systolisch/Diastolisch) erfasst werden.
                **NEU:** Geburtsdatum und K√∂rpergr√∂√üe werden gespeichert, um den Body-Mass-Index (BMI) zu berechnen.
            </p>
            <p class="font-semibold mt-2">Automatische Erg√§nzung (Wetter):</p>
            <p class="text-sm">
                Durch einmaligen Geolocation-Zugriff erfasst die Anwendung zus√§tzlich automatisch die Temperatur und den Wetterzustand des jeweiligen Zeitpunkts, um eine umfassendere Dokumentation zu erm√∂glichen.
            </p>

            <h3 class="text-xl font-bold text-gray-800 border-b pb-1">üìä Nachverfolgung & Analyse (Historie/Diagramme)</h3>
            <p class="font-semibold mt-2">Chronologische Historie:</p>
            <p class="text-sm">
                Alle gespeicherten Eintr√§ge werden in einer sortierten, chronologischen Historie angezeigt.
            </p>
            <p class="font-semibold mt-2">Multivariate Analyse (Linien-Chart f√ºr Stimmung/Schmerz/Wetter):</p>
            <p class="text-sm">
                Sie k√∂nnen den multivariaten Verlauf Ihrer Stimmung, der Schmerzintensit√§t und der Temperatur in einem √ºbersichtlichen Liniendiagramm analysieren, um tiefere Zusammenh√§nge, Muster und Trends in Ihrem Wohlbefinden zu erkennen.
            </p>
            <p class="font-semibold mt-2">Vitalfunktionen-Analyse (Linien-Chart):</p>
            <p class="text-sm">
                Ein dediziertes Diagramm zeigt die Entwicklung von Puls, Gewicht, Blutzucker und Blutdruck sowie BMI √ºber die Zeit.
            </p>
            <p class="font-semibold mt-2">Schmerzregionen-Analyse (Kuchen-Chart):</p>
            <p class="text-sm">
                Ein zus√§tzliches Diagramm zeigt die prozentuale Verteilung der erfassten Schmerzregionen an, um festzustellen, wo Schmerzen am h√§ufigsten auftreten.
            </p>

            <h3 class="text-xl font-bold text-gray-800 border-b pb-1">üíæ Datensicherheit & Verwaltung</h3>
            <p class="font-semibold mt-2">Lokale Speicherung:</p>
            <p class="text-sm">
                Alle Ihre Eintr√§ge werden ausschlie√ülich lokal in Ihrem Browser gespeichert (mithilfe des $\text{localStorage}$-Speichers). Dies bietet maximale Privatsph√§re, da keine Daten an externe Server gesendet oder dort gespeichert werden.
            </p>
            <p class="font-semibold mt-2">Backup-Funktion:</p>
            <p class="text-sm">
                Zum Schutz vor Datenverlust (z. B. durch Browser-Updates, L√∂schen des Cache oder Ger√§tewechsel) k√∂nnen Sie jederzeit eine vollst√§ndige Sicherungskopie Ihrer Daten in Form einer Datei exportieren (Backup). Es wird empfohlen, dies regelm√§√üig zu tun.
            </p>
            <p class="font-semibold mt-2">Restore-Funktion:</p>
            <p class="text-sm">
                √úber die Restore-Funktion k√∂nnen Sie eine zuvor erstellte Sicherungsdatei (Backup) importieren, um Ihre Eintr√§ge wiederherzustellen oder auf ein neues Ger√§t zu √ºbertragen. Beim Wiederherstellen werden die vorhandenen lokalen Daten mit den importierten Daten zusammengef√ºhrt.
            </p>
        </div>
    </div>
</div>

<div id="user-modal" class="modal-overlay">
    <div class="modal-content">
        <button id="close-user-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold p-1">
            &times;
        </button>
        <h2 class="text-2xl font-extrabold text-indigo-700 mb-4">üßë‚Äçü§ù‚Äçüßë Benutzerverwaltung</h2>
        
        <div class="mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold mb-2">Benutzer wechseln</h3>
            <select id="user-list-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <option value="" disabled>W√§hle einen Benutzer</option>
            </select>
            <button id="switch-user-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md mt-2 disabled:opacity-50" disabled>
                Benutzer wechseln
            </button>
        </div>
        
        <div class="mb-4 pb-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold mb-2">Neuen Benutzer hinzuf√ºgen</h3>
            <input type="text" id="new-user-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Name des neuen Benutzers">
            <button id="add-user-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-150 shadow-md mt-2 disabled:opacity-50">
                Benutzer hinzuf√ºgen
            </button>
            <p id="user-status-message" class="mt-2 text-sm text-center font-medium h-4"></p>
        </div>

        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <h3 class="text-lg font-semibold mb-2 text-red-800">‚ùå Benutzer dauerhaft l√∂schen</h3>
            <p class="text-sm text-red-600 mb-3 font-medium">ACHTUNG: Dies l√∂scht ALLE Tagebucheintr√§ge und Vitaldaten dieses Benutzers unwiderruflich!</p>
            <select id="user-delete-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                <option value="" disabled>W√§hle einen zu l√∂schenden Benutzer</option>
            </select>
            <button id="delete-user-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150 shadow-md mt-2 disabled:opacity-50" disabled>
                Ausgew√§hlten Benutzer l√∂schen
            </button>
        </div>
        </div>
</div>
<button id="scrollToTopBtn" class="scroll-to-top" title="Zum Seitenanfang scrollen">
    ‚¨ÜÔ∏è
</button>


<script src="chart.umd.js"></script>

<script>

    const LOCAL_STORAGE_KEY_BASE = 'stimmungstagebuch_data_';
    const USER_VITAL_INFO_KEY_BASE = 'user_vital_info_'; 
    const ACTIVE_USER_KEY = 'active_stimmungs_user';
    const USER_LIST_KEY = 'stimmungs_user_list';
    
    let activeUser = 'Standard'; 
    
    let selectedPeriod = null;
    let selectedMood = null;
    let selectedPain = null; 
    let allStoredEntries = []; 
    let userVitalInfo = {}; 

    const WEATHER_API_BASE_URL = "https://api.open-meteo.com/v1/forecast";
    let currentTemperatureData = null; 
    let userLatitude = null; 
    let userLongitude = null; 
    let lastFetchedDate = null; 
    const PERIOD_TIME_MAP = { 'Nacht': 3, 'Morgen': 9, 'Mittag': 13, 'Abend': 19 };
    const AUTO_PERIOD_MAP = [ { name: 'Nacht', startHour: 0, endHour: 5 }, { name: 'Morgen', startHour: 5, endHour: 12 }, { name: 'Mittag', startHour: 12, endHour: 18 }, { name: 'Abend', startHour: 18, endHour: 24 } ];
    const WMO_CODE_MAP = { 0: 'Klarer Himmel ‚òÄÔ∏è', 1: 'Haupts√§chlich klar üå§Ô∏è', 2: 'Teilweise bew√∂lkt üå•Ô∏è', 3: 'Bedeckt ‚òÅÔ∏è', 45: 'Nebel üå´Ô∏è', 48: 'Reif-/Gl√§tte-Nebel üå´Ô∏è', 51: 'Leichter Nieselregen üåßÔ∏è', 53: 'M√§√üiger Nieselregen üåßÔ∏è', 55: 'Starker Nieselregen üåßÔ∏è', 56: 'Leichter gefrierender Nieselregen üå®Ô∏è', 57: 'Starker gefrierender Nieselregen üå®Ô∏è', 61: 'Leichter Regen üåßÔ∏è', 63: 'M√§√üiger Regen üåßÔ∏è', 65: 'Starker Regen üåßÔ∏è', 66: 'Leichter gefrierender Regen ‚ùÑÔ∏è', 67: 'Starker gefrierender Regen ‚ùÑÔ∏è', 71: 'Leichter Schneefall üå®Ô∏è', 73: 'M√§√üiger Schneefall üå®Ô∏è', 75: 'Starker Schneefall üå®Ô∏è', 77: 'Schneegriesel ‚ùÑÔ∏è', 80: 'Leichte Regenschauer üå¶Ô∏è', 81: 'M√§√üige Regenschauer üå¶Ô∏è', 82: 'Starke Regenschauer ‚õàÔ∏è', 85: 'Leichte Schneeschauer üå®Ô∏è', 86: 'Starke Schneeschauer üå®Ô∏è', 95: 'Gewitter (leicht/m√§√üig) üå©Ô∏è', 96: 'Gewitter mit leichtem Hagel ‚õàÔ∏è', 99: 'Gewitter mit starkem Hagel ‚õàÔ∏è' };
    const PAIN_REGION_NAMES = { 'oben': 'Oben', 'mitte': 'Mitte', 'unten': 'Unten' };
    const entryDateEl = document.getElementById('entry-date'); 
    const timePeriodsEl = document.getElementById('time-periods');
    const moodSelectionEl = document.getElementById('mood-selection');
    const painSelectionEl = document.getElementById('pain-selection'); 
    const painRegionsFieldset = document.getElementById('pain-regions'); 
    const pulsEl = document.getElementById('puls'); 
    const gewichtEl = document.getElementById('gewicht'); 
    const blutzuckerEl = document.getElementById('blutzucker'); 
    const blutdruckSysEl = document.getElementById('blutdruckSys'); 
    const blutdruckDiaEl = document.getElementById('blutdruckDia');
    const noteEl = document.getElementById('note');
    const saveButton = document.getElementById('save-entry');
    const statusMessageEl = document.getElementById('status-message');
    const historyContainerEl = document.getElementById('history-container');
    const loadingHistoryEl = document.getElementById('loading-history');
    const noEntriesEl = document.getElementById('no-entries');
    const resetButton = document.getElementById('reset-data'); 
    const resetStatusEl = document.getElementById('reset-status'); 
    const weatherStatusEl = document.getElementById('weather-status'); 
    const yearFilterEl = document.getElementById('year-filter'); 
    const monthFilterEl = document.getElementById('month-filter');
    const statsContainerEl = document.getElementById('stats-container');
    const jsonFileInput = document.getElementById('json-file-input');
    const importButton = document.getElementById('import-data');
    const importStatusEl = document.getElementById('import-status');
    const exportButton = document.getElementById('export-data');
    const exportChartButton = document.getElementById('export-chart-button');
    const exportPainChartButton = document.getElementById('export-pain-chart-button'); 
    const exportVitalChartButton = document.getElementById('export-vital-chart-button');
    const helpButton = document.getElementById('help-button');
    const helpModal = document.getElementById('help-modal');
    const closeModalButton = document.getElementById('close-modal');
    const geburtsdatumEl = document.getElementById('geburtsdatum');
    const koerpergroesseEl = document.getElementById('koerpergroesse');
    const bmiDisplayEl = document.getElementById('bmi-display');
    
    const manageUsersBtn = document.getElementById('manage-users-btn');
    const userModal = document.getElementById('user-modal');
    const closeUserModalBtn = document.getElementById('close-user-modal');
    const userListSelect = document.getElementById('user-list-select');
    const switchUserBtn = document.getElementById('switch-user-btn');
    const newUserNameInput = document.getElementById('new-user-name');
    const addUserBtn = document.getElementById('add-user-btn');
    const currentUserDisplay = document.getElementById('current-user-display');
    const userStatusMessage = document.getElementById('user-status-message');

    const userDeleteSelect = document.getElementById('user-delete-select');
    const deleteUserBtn = document.getElementById('delete-user-btn');

    entryDateEl.value = new Date().toISOString().split('T')[0]; 
    const MOOD_EMOJIS = { 'sehr_gut': 'üòÄ', 'gut': 'üôÇ', 'neutral': 'üòê', 'schlecht': 'üôÅ', 'sehr_schlecht': 'üòû' };
    window.MOOD_NAMES = { 'sehr_gut': 'Sehr gut', 'gut': 'Gut', 'neutral': 'Neutral', 'schlecht': 'Schlecht', 'sehr_schlecht': 'Sehr schlecht' };
    window.MOOD_VALUES = { 'sehr_schlecht': 1, 'schlecht': 2, 'neutral': 3, 'gut': 4, 'sehr_gut': 5 };
    const MONTH_NAMES = [ "Januar", "Februar", "M√§rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember" ];

    function getLocalStorageKey() {
        return LOCAL_STORAGE_KEY_BASE + activeUser;
    }

    function getUserVitalInfoKey() {
        return USER_VITAL_INFO_KEY_BASE + activeUser;
    }


    function loadUserVitalInfo() {
        try {
            const data = localStorage.getItem(getUserVitalInfoKey());
            userVitalInfo = data ? JSON.parse(data) : {};
        } catch (e) {
            console.error("Fehler beim Laden der Benutzer-Vitaldaten:", e);
            userVitalInfo = {};
        }
    }
    
    function saveUserVitalInfo(geburtsdatum, koerpergroesse) {
        userVitalInfo.geburtsdatum = geburtsdatum;
        userVitalInfo.koerpergroesse = koerpergroesse;
        try {
            localStorage.setItem(getUserVitalInfoKey(), JSON.stringify(userVitalInfo));
        } catch (e) {
            console.error("Fehler beim Speichern der Benutzer-Vitaldaten:", e);
        }
    }

    function loadEntriesFromLocalStorage() {
        try {
            const data = localStorage.getItem(getLocalStorageKey());
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Fehler beim Laden aus localStorage:", e);
            return [];
        }
    }

    function saveEntriesToLocalStorage(entries) {
        try {
            localStorage.setItem(getLocalStorageKey(), JSON.stringify(entries));
            allStoredEntries = entries; 
        } catch (e) {
            console.error("Fehler beim Speichern in localStorage:", e);
        }
    }
    
    function getSavedUsers() {
        try {
            const users = localStorage.getItem(USER_LIST_KEY);
            return users ? JSON.parse(users).sort((a, b) => a.localeCompare(b)) : ['Standard']; 
        } catch (e) {
            console.error("Fehler beim Laden der Benutzerliste:", e);
            return ['Standard'];
        }
    }

    function saveUsers(users) {
        try {
            localStorage.setItem(USER_LIST_KEY, JSON.stringify(users));
        } catch (e) {
            console.error("Fehler beim Speichern der Benutzerliste:", e);
        }
    }
    
    function loadActiveUser() {
        const users = getSavedUsers();
        const savedUser = localStorage.getItem(ACTIVE_USER_KEY);
        
        if (savedUser && users.includes(savedUser)) {
            activeUser = savedUser;
        } else {
            activeUser = users[0] || 'Standard';
            if (!users.includes('Standard')) {
                users.push('Standard');
                saveUsers(users);
            }
            localStorage.setItem(ACTIVE_USER_KEY, activeUser);
        }
        currentUserDisplay.textContent = activeUser;
    }
    
    function switchToUser(username) {
        if (username === activeUser) return;
        localStorage.setItem(ACTIVE_USER_KEY, username);

        window.location.reload(); 
    }

    function populateUserDeleteList() {
        const users = getSavedUsers();
        userDeleteSelect.innerHTML = '<option value="" disabled selected>W√§hle einen zu l√∂schenden Benutzer</option>';
        let hasDeletableUser = false;
        
        users.forEach(user => {
            if (user !== activeUser) {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userDeleteSelect.appendChild(option);
                hasDeletableUser = true;
            }
        });
        
        if (!hasDeletableUser) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Keine anderen Benutzer verf√ºgbar';
            userDeleteSelect.appendChild(option);
            userDeleteSelect.disabled = true;
            deleteUserBtn.disabled = true;
        } else {
            userDeleteSelect.disabled = false;
        }
    }

    function handleDeleteUser() {
        const userToDelete = userDeleteSelect.value;
        if (!userToDelete) return;
        
        if (!confirm(`SIND SIE SICHER? Alle Daten (Eintr√§ge und Vitaldaten) des Benutzers "${userToDelete}" werden unwiderruflich gel√∂scht!`)) {
            return;
        }

        localStorage.removeItem(LOCAL_STORAGE_KEY_BASE + userToDelete);
        localStorage.removeItem(USER_VITAL_INFO_KEY_BASE + userToDelete);
        

        let users = getSavedUsers();
        users = users.filter(u => u !== userToDelete);
        saveUsers(users);

        userStatusMessage.textContent = `Benutzer "${userToDelete}" und seine Daten wurden gel√∂scht.`;
        userStatusMessage.className = 'mt-2 text-sm text-center font-medium text-green-600 h-4';
        

        populateUserModal();
    }
    
    function populateUserModal() {
        const users = getSavedUsers();
        userListSelect.innerHTML = '';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user + (user === activeUser ? ' (Aktiv)' : '');
            userListSelect.appendChild(option);
        });
        userListSelect.value = activeUser;
        switchUserBtn.disabled = true; 
        
        populateUserDeleteList();

        newUserNameInput.value = '';
        addUserBtn.disabled = true;
        userModal.classList.add('modal-show');
    }

    function handleSwitchUser() {
        const selectedUser = userListSelect.value;
        if (selectedUser && selectedUser !== activeUser) {
            switchToUser(selectedUser);
        }
    }

    function handleAddUser() {
        const newName = newUserNameInput.value.trim();
        if (!newName) {
            userStatusMessage.textContent = 'Bitte einen Namen eingeben.';
            userStatusMessage.className = 'mt-2 text-sm text-center font-medium text-red-600 h-4';
            return;
        }
        let users = getSavedUsers();
        if (users.map(u => u.toLowerCase()).includes(newName.toLowerCase())) {
            userStatusMessage.textContent = `Benutzer "${newName}" existiert bereits.`;
            userStatusMessage.className = 'mt-2 text-sm text-center font-medium text-red-600 h-4';
            return;
        }
        users.push(newName);
        saveUsers(users);
        populateUserModal(); 
        userStatusMessage.textContent = `Benutzer "${newName}" hinzugef√ºgt. Jetzt wechseln!`;
        userStatusMessage.className = 'mt-2 text-sm font-medium text-green-600 h-4';
        userListSelect.value = newName; 
        switchUserBtn.disabled = false;
        addUserBtn.disabled = true;
    }

    function generatePainButtons() {
        let html = '';
        for (let i = 0; i <= 10; i++) {
            let title = '';
            if (i === 0) {
                title = 'Keine Schmerzen';
            } else if (i === 10) {
                title = 'St√§rkste Schmerzen';
            } else {
                title = 'Schmerzstufe ' + i;
            }

            html += `
                <button class="pain-button text-sm w-8 h-8 rounded-full border border-gray-300 transition duration-100 hover:bg-red-100" data-pain="${i}" title="${title}">
                    ${i}
                </button>
            `;
        }
        painSelectionEl.innerHTML = html;
    }


    function calculateBMI(weightKg, heightCm) {
        if (weightKg > 0 && heightCm > 0) {
            const heightM = heightCm / 100;

            const bmi = weightKg / (heightM * heightM); 
            return bmi.toFixed(1);
        }
        return 'N/A';
    }

    function calculateAndDisplayBMI() {
        const weight = getNumericValue(gewichtEl);
        const height = getNumericValue(koerpergroesseEl);
        const bmi = calculateBMI(weight, height);
        
        bmiDisplayEl.value = bmi;
        

        bmiDisplayEl.className = `w-full p-2 border border-gray-300 rounded-lg text-center font-bold 
            ${bmi === 'N/A' ? 'bg-gray-100' : 
            bmi < 18.5 ? 'bg-blue-200 text-blue-800' : 
            bmi < 25 ? 'bg-green-200 text-green-800' : 
            bmi < 30 ? 'bg-yellow-200 text-yellow-800' : 
            'bg-red-200 text-red-800'}`;
    }

    function preselectTimePeriod() {
        document.querySelectorAll('.period-button').forEach(b => b.classList.remove('selected-period'));
        selectedPeriod = null; 
        const currentHour = new Date().getHours();
        let periodToSelect = null;
        for (const period of AUTO_PERIOD_MAP) {
            if (currentHour >= period.startHour && currentHour < period.endHour) {
                periodToSelect = period.name;
                break;
            }
        }
        if (periodToSelect) {
            const btn = document.querySelector(`.period-button[data-period="${periodToSelect}"]`);
            if (btn) {
                selectedPeriod = periodToSelect;
                btn.classList.add('selected-period');
            }
        }
    }
    
    function resetInputFields() {
        document.querySelectorAll('.period-button').forEach(b => b.classList.remove('selected-period'));
        document.querySelectorAll('.mood-icon').forEach(i => i.classList.remove('selected-mood'));
        document.querySelectorAll('.pain-button').forEach(b => b.classList.remove('selected-pain'));
        
        selectedPeriod = null;
        selectedMood = null;
        selectedPain = null; 
        
        entryDateEl.value = new Date().toISOString().split('T')[0]; 
        
        painRegionsFieldset.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
        pulsEl.value = '';
        gewichtEl.value = '';

        blutzuckerEl.value = '';
        blutdruckSysEl.value = '';
        blutdruckDiaEl.value = '';
        noteEl.value = '';

        calculateAndDisplayBMI();
        preselectTimePeriod(); 
        checkFormValidity();
        updateWeatherDisplayForSelectedPeriod();
        fetchWeather(entryDateEl.value); 
    }

    function setupApp() {
        loadActiveUser();
        allStoredEntries = loadEntriesFromLocalStorage(); 
        loadUserVitalInfo(); 
        
        geburtsdatumEl.value = userVitalInfo.geburtsdatum || '';
        koerpergroesseEl.value = userVitalInfo.koerpergroesse || '';
        
        generatePainButtons(); 
        preselectTimePeriod(); 
        calculateAndDisplayBMI(); 
        renderSortedHistory(allStoredEntries, true); 
        fetchWeather(entryDateEl.value); 
    }
    function updateWeatherDisplayForSelectedPeriod() {
        if (userLatitude === null || userLongitude === null) {
            if (weatherStatusEl.textContent.includes('Timeout') || weatherStatusEl.textContent.includes('verweigert')) {
                return; 
            }
            if (!weatherStatusEl.textContent.includes('Lade Standort')) {
                 weatherStatusEl.textContent = 'Standort nicht verf√ºgbar. Eintrag ohne Wetter.';
            }
            return;
        }

        if (!selectedPeriod) {
            weatherStatusEl.textContent = 'W√§hlen Sie einen Zeitraum f√ºr die Wetterinformation.';
            return;
        }
        const weather = getWeatherDataForPeriod(selectedPeriod, entryDateEl.value);
        if (weather.temperature !== null) {
            weatherStatusEl.textContent = `‚úÖ Wetter f√ºr ${selectedPeriod}: ${weather.temperature}¬∞C, ${weather.weatherCondition}`;
        } else if (currentTemperatureData === null || currentTemperatureData.length === 0) {
            weatherStatusEl.textContent = 'Lade Wetterdaten...'; 
        } else {
            weatherStatusEl.textContent = '‚ö†Ô∏è Keine pr√§zisen Wetterdaten f√ºr diese Zeit gefunden.';
        }
    }
    
    let retryCount = 0; 
    const MAX_RETRIES = 2; 

    async function fetchWeather(targetDateStr) {
        if (!targetDateStr) return; 
        
        if (userLatitude !== null && userLongitude !== null && lastFetchedDate && currentTemperatureData && currentTemperatureData.length > 0) {
            const targetTime = new Date(targetDateStr).getTime();
            const loadedStartTime = new Date(lastFetchedDate).getTime();
            const fourteenDaysInMs = 14 * 24 * 60 * 60 * 1000;
            const loadedEndTime = loadedStartTime + fourteenDaysInMs;
            
            if (targetTime >= loadedStartTime && targetTime < loadedEndTime) {
                updateWeatherDisplayForSelectedPeriod();
                checkFormValidity(); 
                retryCount = 0;
                return;
            }
        }
        
        if (userLatitude === null || retryCount > 0) { 
            if (!navigator.geolocation) {
                weatherStatusEl.textContent = 'Geolocation wird nicht unterst√ºtzt. Wetterdaten nicht verf√ºgbar.';
                checkFormValidity(); 
                userLatitude = null; userLongitude = null; 
                updateWeatherDisplayForSelectedPeriod();
                return;
            }

            if (retryCount === 0) {
                weatherStatusEl.textContent = 'Lade Standort... (Bitte erlauben Sie den Zugriff)';
            } else {
                weatherStatusEl.textContent = `Standort-Timeout! Starte Versuch ${retryCount + 1}/${MAX_RETRIES + 1} ...`;
            }

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { 
                        timeout: 5000,
                        enableHighAccuracy: false 
                    });
                });
                userLatitude = position.coords.latitude; 
                userLongitude = position.coords.longitude; 
                retryCount = 0;
            } catch (error) {
                console.error("Fehler beim Abrufen des Standorts:", error);
                
                if (error.code === error.TIMEOUT && retryCount < MAX_RETRIES) {
                    retryCount++; 
                    console.warn(`Geolocation Timeout (Versuch ${retryCount}/${MAX_RETRIES}). Starte sofort erneute Abfrage...`);
                    return fetchWeather(targetDateStr); 
                }

                if (error.code === error.PERMISSION_DENIED) {
                     weatherStatusEl.textContent = '‚ùå Standortzugriff verweigert. Eintrag ohne Wetter.';
                } else if (error.code === error.TIMEOUT) {
                     weatherStatusEl.textContent = `‚ùå Standortabfrage-Timeout nach ${MAX_RETRIES + 1} Versuchen. Eintrag ohne Wetter.`;
                } else {
                     weatherStatusEl.textContent = '‚ùå Fehler beim Laden des Standorts. Eintrag ohne Wetter.';
                }

                userLatitude = null; 
                userLongitude = null; 
                currentTemperatureData = null; 
                retryCount = 0;
                updateWeatherDisplayForSelectedPeriod(); 
                checkFormValidity(); 
                return; 
            }
        } 
        
        weatherStatusEl.textContent = `Wetterdaten f√ºr ${window.formatDateShort(targetDateStr)} abrufen...`;
        await fetchWeatherData(userLatitude, userLongitude, targetDateStr);
        updateWeatherDisplayForSelectedPeriod(); 
        checkFormValidity(); 
    }


    async function fetchWeatherData(lat, lon, startDateStr) {
        const startDate = new Date(startDateStr);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 14); 
        const startDateFormatted = startDateStr;
        const endDateFormatted = endDate.toISOString().split('T')[0];
        const url = `${WEATHER_API_BASE_URL}?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode&timezone=auto&start_date=${startDateFormatted}&end_date=${endDateFormatted}`; 
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API Fehler: ${response.status}`);
            const data = await response.json();
            const hourlyData = data.hourly.time.map((timestamp, index) => ({
                timestamp: new Date(timestamp).getTime(), 
                temp: data.hourly.temperature_2m[index],
                wmoCode: data.hourly.weathercode[index] 
            }));
            currentTemperatureData = hourlyData; 
            lastFetchedDate = startDateStr; 
            
            updateWeatherDisplayForSelectedPeriod(); 
            checkFormValidity(); 
        } catch (error) {
            console.error("Fehler beim Abrufen der Wetterdaten:", error);
            weatherStatusEl.textContent = '‚ùå Fehler beim Laden der Wetterdaten. Eintrag ohne Temperatur/Wetterzustand.';
            currentTemperatureData = null; 
            checkFormValidity(); 
            updateWeatherDisplayForSelectedPeriod();
        }
    }

    function getWeatherDataForPeriod(period, selectedDateStr) { 
        if (!selectedDateStr || !currentTemperatureData || currentTemperatureData.length === 0 || !period) {
             return { temperature: null, weatherCondition: null }; 
        }
        const targetHour = PERIOD_TIME_MAP[period];
        if (!targetHour) return { temperature: null, weatherCondition: null };
        const [year, month, day] = selectedDateStr.split('-').map(Number);
        let targetTime = new Date(year, month - 1, day, targetHour, 0, 0); 
        const targetTimestampMs = targetTime.getTime(); 
        let closestEntry = null;
        let minDiff = Infinity;
        currentTemperatureData.forEach(entry => {
            const diff = Math.abs(entry.timestamp - targetTimestampMs); 
            if (diff < minDiff && diff < (12 * 60 * 60 * 1000)) { 
                minDiff = diff;
                closestEntry = entry;
            }
        });
        if (closestEntry) {
            const temp = parseFloat(closestEntry.temp.toFixed(1));
            const condition = WMO_CODE_MAP[closestEntry.wmoCode] || 'Unbekannt'; 
            return { temperature: temp, weatherCondition: condition };
        } else {
            console.warn(`Keine Wetterdaten f√ºr ${selectedDateStr} - ${period} in den geladenen Daten gefunden.`);
            return { temperature: null, weatherCondition: null };
        }
    }

    function checkFormValidity() {
        const selectedDate = entryDateEl.value; 
        saveButton.disabled = !(selectedDate && selectedPeriod && selectedMood && selectedPain !== null); 
        saveButton.textContent = saveButton.disabled ? 'Bitte Datum, Zeitraum, Stimmung und Schmerz w√§hlen' : 'Eintrag speichern';
    }

    function showHelpModal() { helpModal.classList.add('modal-show'); }
    function closeHelpModal() { helpModal.classList.remove('modal-show'); }
    
    function exportChart(chartId) {
        const chartCanvas = document.getElementById(chartId);
        if (!chartCanvas) { alert("Das Diagramm existiert nicht."); return; }
        const chartInstance = Chart.getChart(chartCanvas);
        if (!chartInstance) { alert("Das Diagramm kann nicht exportiert werden, da es keine Daten enth√§lt."); return; }
        const imageURL = chartCanvas.toDataURL('image/png');
        const action = prompt("M√∂chten Sie das Diagramm speichern (S) oder drucken (D)?", "S");
        const filenamePrefix = chartId.includes('moodChart') ? 'stimmungs_chart' : (chartId.includes('vitalChart') ? 'vital_chart' : 'schmerzregionen_chart');

        if (action && action.toUpperCase() === 'S') {
            const a = document.createElement('a');
            a.href = imageURL;
            a.download = `${filenamePrefix}_${activeUser}_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else if (action && action.toUpperCase() === 'D') {
            const printWindow = window.open('');
            printWindow.document.write('<img src="' + imageURL + '" style="max-width: 100%;">');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }
    }
    
    function toggleScrollButton() {
        const button = document.getElementById('scrollToTopBtn');
        if (window.scrollY > 200) { 
            button.style.display = 'flex';
        } else {
            button.style.display = 'none';
        }
    }

    function setupFormListeners() {
        geburtsdatumEl.addEventListener('input', calculateAndDisplayBMI);
        koerpergroesseEl.addEventListener('input', calculateAndDisplayBMI);
        gewichtEl.addEventListener('input', calculateAndDisplayBMI);
        
        entryDateEl.addEventListener('change', () => {
            checkFormValidity();
            fetchWeather(entryDateEl.value); 
            updateWeatherDisplayForSelectedPeriod();
        });

        timePeriodsEl.addEventListener('click', (e) => {
            const btn = e.target.closest('.period-button');
            if (btn) {
                document.querySelectorAll('.period-button').forEach(b => b.classList.remove('selected-period'));
                selectedPeriod = btn.dataset.period;
                btn.classList.add('selected-period');
                checkFormValidity();
                
                updateWeatherDisplayForSelectedPeriod(); 

                if (entryDateEl.value) { 
                    fetchWeather(entryDateEl.value); 
                }
            }
        });

        moodSelectionEl.addEventListener('click', (e) => {
            const icon = e.target.closest('.mood-icon');
            if (icon) {
                document.querySelectorAll('.mood-icon').forEach(i => i.classList.remove('selected-mood'));
                selectedMood = icon.dataset.mood;
                icon.classList.add('selected-mood');
                checkFormValidity();
            }
        });

        painSelectionEl.addEventListener('click', (e) => {
            const btn = e.target.closest('.pain-button');
            if (btn) {
                document.querySelectorAll('.pain-button').forEach(b => b.classList.remove('selected-pain'));
                selectedPain = parseInt(btn.dataset.pain, 10); 
                btn.classList.add('selected-pain');
                checkFormValidity();
            }
        });
        
        saveButton.addEventListener('click', saveEntry);
        resetButton.addEventListener('click', resetData); 
        exportButton.addEventListener('click', exportData); 
        exportChartButton.addEventListener('click', () => exportChart('moodChart')); 
        exportPainChartButton.addEventListener('click', () => exportChart('painRegionChart')); 
        exportVitalChartButton.addEventListener('click', () => exportChart('vitalChart'));
        
        jsonFileInput.addEventListener('change', () => { importButton.disabled = !jsonFileInput.files.length; });
        importButton.addEventListener('click', importData);
        
        yearFilterEl.addEventListener('change', () => {
            populateMonthFilter(yearFilterEl.value);
            filterHistoryByYearMonth(yearFilterEl.value, monthFilterEl.value);
        });
        
        monthFilterEl.addEventListener('change', () => {
            filterHistoryByYearMonth(yearFilterEl.value, monthFilterEl.value);
        });

        helpButton.addEventListener('click', showHelpModal);
        closeModalButton.addEventListener('click', closeHelpModal);
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) { closeHelpModal(); }
        });
        
        document.getElementById('scrollToTopBtn').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        });
        
        window.addEventListener('scroll', toggleScrollButton);
        toggleScrollButton(); 
        
        
        manageUsersBtn.addEventListener('click', populateUserModal);
        closeUserModalBtn.addEventListener('click', () => { userModal.classList.remove('modal-show'); });
        userModal.addEventListener('click', (e) => {
            if (e.target === userModal) { userModal.classList.remove('modal-show'); }
        });
        userListSelect.addEventListener('change', () => { switchUserBtn.disabled = userListSelect.value === activeUser; });
        newUserNameInput.addEventListener('input', () => { 
            const name = newUserNameInput.value.trim();
            const users = getSavedUsers().map(u => u.toLowerCase());
            addUserBtn.disabled = name === '' || users.includes(name.toLowerCase()); 
        });
        switchUserBtn.addEventListener('click', handleSwitchUser);
        addUserBtn.addEventListener('click', handleAddUser);
        
        
        userDeleteSelect.addEventListener('change', () => { deleteUserBtn.disabled = userDeleteSelect.value === ''; });
        deleteUserBtn.addEventListener('click', handleDeleteUser);


        checkFormValidity();
    }
    
    function calculateAge(birthdateString) {
        if (!birthdateString) return null;
        const today = new Date();
        const birthDate = new Date(birthdateString);
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    function getSelectedPainRegions() {
        const selectedRegions = [];
        painRegionsFieldset.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            selectedRegions.push(checkbox.value);
        });
        return selectedRegions;
    }

    function getNumericValue(element) {
        const value = element.value.trim();
        return value === '' ? null : parseFloat(value);
    }

    function saveEntry() {
        const entryDate = entryDateEl.value; 
        if (!entryDate || !selectedPeriod || !selectedMood || selectedPain === null) {
            statusMessageEl.textContent = "Bitte alle notwendigen Felder (Datum, Zeitraum, Stimmung, Schmerz) ausf√ºllen.";
            statusMessageEl.className = 'mt-3 text-center text-sm font-medium text-red-600 h-4';
            return;
        }

        saveButton.disabled = true;
        statusMessageEl.textContent = 'Speichere...';
        statusMessageEl.className = 'mt-3 text-center text-sm font-medium text-blue-600 h-4';

        const docId = `${entryDate}_${selectedPeriod}`; 
        const weather = getWeatherDataForPeriod(selectedPeriod, entryDate); 
        const painRegions = getSelectedPainRegions(); 
        
        const geburtsdatum = geburtsdatumEl.value.trim() || null;
        const koerpergroesse = getNumericValue(koerpergroesseEl);
        
        saveUserVitalInfo(geburtsdatum, koerpergroesse); 

        const gewicht = getNumericValue(gewichtEl);
        const bmi = calculateBMI(gewicht, koerpergroesse);
        const alter = calculateAge(geburtsdatum);

        const newEntry = {
            id: docId, 
            date: entryDate, 
            timePeriod: selectedPeriod,
            mood: selectedMood,
            pain: selectedPain, 
            schmerzRegionen: painRegions, 
            geburtsdatum: geburtsdatum, 
            koerpergroesse: koerpergroesse, 
            alter: alter, 
            gewicht: gewicht,
            bmi: bmi,
            puls: getNumericValue(pulsEl), 
            blutzucker: getNumericValue(blutzuckerEl),
            blutdruckSys: getNumericValue(blutdruckSysEl),
            blutdruckDia: getNumericValue(blutdruckDiaEl),
            note: noteEl.value.trim(),
            temperature: weather.temperature, 
            weatherCondition: weather.weatherCondition, 
            timestamp: new Date().getTime() 
        };

        const existingIndex = allStoredEntries.findIndex(e => e.id === docId);
        if (existingIndex > -1) {
            allStoredEntries[existingIndex] = newEntry; 
        } else {
            allStoredEntries.push(newEntry); 
        }

        try {
            saveEntriesToLocalStorage(allStoredEntries);
            statusMessageEl.textContent = 'Eintrag erfolgreich gespeichert!';
            statusMessageEl.className = 'mt-3 text-center text-sm font-medium text-green-600 h-4';
            
            setTimeout(() => {
                window.location.reload(); 
            }, 1500);

        } catch (error) {
            console.error("Fehler beim Speichern:", error);
            statusMessageEl.textContent = 'Fehler beim Speichern des Eintrags.';
            statusMessageEl.className = 'mt-3 text-center text-sm font-medium text-red-600 h-4';
        } finally {
            saveButton.disabled = false;
        }
    }

    function loadHistoryAndStartListening() {
        renderSortedHistory(allStoredEntries, true);
    }
    
    function populateYearFilter(entries) {
        const uniqueYears = Array.from(new Set(entries.map(entry => entry.date.substring(0, 4))));
        uniqueYears.sort().reverse();
        const currentValue = yearFilterEl.value;
        yearFilterEl.innerHTML = '<option value="all">Alle Jahre</option>';
        uniqueYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year; 
            yearFilterEl.appendChild(option);
        });
        if (uniqueYears.includes(currentValue) || currentValue === 'all') {
             yearFilterEl.value = currentValue;
        }
        populateMonthFilter(yearFilterEl.value);
    }
    
    function populateMonthFilter(selectedYear) {
        monthFilterEl.innerHTML = '<option value="all">Alle Monate</option>';
        if (selectedYear === 'all') {
            monthFilterEl.disabled = true;
            return;
        }
        monthFilterEl.disabled = false;
        const uniqueMonths = Array.from(new Set(
            allStoredEntries
                .filter(entry => entry.date.startsWith(selectedYear))
                .map(entry => entry.date.substring(5, 7))
        ));
        uniqueMonths.sort((a, b) => parseInt(b, 10) - parseInt(a, 10));

        uniqueMonths.forEach(monthStr => {
            const monthIndex = parseInt(monthStr, 10) - 1; 
            const monthName = MONTH_NAMES[monthIndex];
            const option = document.createElement('option');
            option.value = monthStr;
            option.textContent = monthName + ' (' + monthStr + ')'; 
            monthFilterEl.appendChild(option);
        });
        if (!uniqueMonths.includes(monthFilterEl.value)) {
            monthFilterEl.value = 'all';
        }
    }

    function filterHistoryByYearMonth(selectedYear, selectedMonth) {
        let filteredEntries = allStoredEntries;
        if (selectedYear !== 'all') {
            filteredEntries = filteredEntries.filter(entry => 
                entry.date.startsWith(selectedYear)
            );
        }
        if (selectedMonth !== 'all') {
            filteredEntries = filteredEntries.filter(entry => 
                entry.date.substring(5, 7) === selectedMonth
            );
        }
        renderStats(filteredEntries);
        renderHistory(filteredEntries);
    }
    
    function renderStats(entries) {
        statsContainerEl.innerHTML = '';
        if (entries.length === 0) {
            statsContainerEl.classList.add('hidden');
            return;
        }
        statsContainerEl.classList.remove('hidden');

        let moodSum = 0;
        let painSum = 0;
        let tempSum = 0;
        let tempCount = 0;
        let pulsSum = 0;
        let pulsCount = 0;
        let gewichtSum = 0;
        let gewichtCount = 0;
        let blutzuckerSum = 0;
        let blutzuckerCount = 0;
        let bmiSum = 0;
        let bmiCount = 0;


        entries.forEach(entry => {
            moodSum += window.MOOD_VALUES[entry.mood] || 3;
            painSum += entry.pain !== undefined && entry.pain !== null ? entry.pain : 0;
            if (entry.temperature !== undefined && entry.temperature !== null) {
                tempSum += entry.temperature;
                tempCount++;
            }
            if (entry.puls !== undefined && entry.puls !== null) {
                pulsSum += entry.puls;
                pulsCount++;
            }
            if (entry.gewicht !== undefined && entry.gewicht !== null) {
                gewichtSum += entry.gewicht;
                gewichtCount++;
            }
            if (entry.blutzucker !== undefined && entry.blutzucker !== null) {
                blutzuckerSum += entry.blutzucker;
                blutzuckerCount++;
            }
             if (entry.bmi !== undefined && entry.bmi !== null && entry.bmi !== 'N/A' && !isNaN(parseFloat(entry.bmi))) {
                bmiSum += parseFloat(entry.bmi);
                bmiCount++;
            }
        });

        const avgMood = (moodSum / entries.length).toFixed(2);
        const avgPain = (painSum / entries.length).toFixed(1);
        const avgTemp = tempCount > 0 ? (tempSum / tempCount).toFixed(1) : 'N/A';
        const avgPuls = pulsCount > 0 ? (pulsSum / pulsCount).toFixed(0) : 'N/A';
        const avgGewicht = gewichtCount > 0 ? (gewichtSum / gewichtCount).toFixed(1) : 'N/A';
        const avgBlutzucker = blutzuckerCount > 0 ? (blutzuckerSum / blutzuckerCount).toFixed(0) : 'N/A';
        const avgBMI = bmiCount > 0 ? (bmiSum / bmiCount).toFixed(1) : 'N/A';


        function createStatCard(title, value, unit, color) {
            const card = document.createElement('div');
            card.className = 'stat-card';
            card.innerHTML = `
                <p class="stat-card-title">${title}</p>
                <p class="stat-card-value" style="color: ${color};">${value}${unit}</p>
            `;
            return card;
        }
        
        const MOOD_COLOR = '#4f46e5';   
        const PAIN_COLOR = '#9333ea';   
        const TEMP_COLOR = '#ef4444';   
        const PULS_COLOR = '#10b981';   
        const GEWICHT_COLOR = '#db2777'; 
        const BLUTZUCKER_COLOR = '#d97706'; 
        const BMI_COLOR = '#4c51bf'; 


        const moodCard = createStatCard( '√ò Stimmung (1-5)', avgMood, '', MOOD_COLOR );
        const painCard = createStatCard( '√ò Schmerz (0-10)', avgPain, '', PAIN_COLOR );
        const tempCard = createStatCard( '√ò Temp', avgTemp, avgTemp !== 'N/A' ? '¬∞C' : '', TEMP_COLOR );
        const pulsCard = createStatCard( '√ò Puls', avgPuls, avgPuls !== 'N/A' ? ' BPM' : '', PULS_COLOR );
        const gewichtCard = createStatCard( '√ò Gewicht', avgGewicht, avgGewicht !== 'N/A' ? ' kg' : '', GEWICHT_COLOR );
        const blutzuckerCard = createStatCard( '√ò BZ', avgBlutzucker, avgBlutzucker !== 'N/A' ? ' mg/dL' : '', BLUTZUCKER_COLOR );
        const bmiCard = createStatCard( '√ò BMI', avgBMI, '', BMI_COLOR );

        statsContainerEl.innerHTML = ''; 
        statsContainerEl.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2 mb-6'; 
        statsContainerEl.appendChild(moodCard);
        statsContainerEl.appendChild(painCard);
        statsContainerEl.appendChild(tempCard);
        statsContainerEl.appendChild(pulsCard);
        statsContainerEl.appendChild(gewichtCard);
        statsContainerEl.appendChild(blutzuckerCard);
        statsContainerEl.appendChild(bmiCard); 
    }

    function renderSortedHistory(entries, updateChartFilter = true) {
        const sortedEntries = entries.sort((a, b) => {
            if (a.date < b.date) return 1;
            if (a.date > b.date) return -1;
            const order = ['Nacht', 'Morgen', 'Mittag', 'Abend']; 
            return order.indexOf(a.timePeriod) - order.indexOf(b.timePeriod);
        });

        if (updateChartFilter) {
            populateYearFilter(allStoredEntries);
            if (typeof renderMoodChart !== 'undefined') { renderMoodChart(allStoredEntries); }
            if (typeof renderPainRegionChart !== 'undefined') { renderPainRegionChart(allStoredEntries); }
            if (typeof renderVitalChart !== 'undefined') { renderVitalChart(allStoredEntries); }
            filterHistoryByYearMonth(yearFilterEl.value, monthFilterEl.value); 
            return; 
        }
        renderHistory(sortedEntries);
    }
    
    function renderHistory(entries) {
        loadingHistoryEl.classList.add('hidden');
        historyContainerEl.innerHTML = '';

        if (entries.length === 0) {
            noEntriesEl.classList.remove('hidden');
            return;
        }
        noEntriesEl.classList.add('hidden');

        const groupedByDate = entries.reduce((acc, entry) => {
            const dateKey = entry.date;
            if (!acc[dateKey]) { acc[dateKey] = []; }
            entry.timestamp = entry.timestamp || new Date(entry.date).getTime(); 
            acc[dateKey].push(entry);
            return acc;
        }, {});

        const sortedDates = Object.keys(groupedByDate).sort().reverse();

        sortedDates.forEach(date => {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'mb-6 border border-gray-200 rounded-lg shadow-md overflow-hidden';

            const dateTitle = document.createElement('h3');
            dateTitle.className = 'bg-indigo-100 text-indigo-800 font-bold p-3 text-lg border-b border-indigo-200';
            dateTitle.textContent = formatDate(date);
            dateGroup.appendChild(dateTitle);

            const entriesList = document.createElement('div');
            groupedByDate[date].forEach(entry => { 
                entriesList.innerHTML += createEntryHtml(entry);
            });
            dateGroup.appendChild(entriesList);
            historyContainerEl.appendChild(dateGroup);
        });
        
        document.querySelectorAll('.delete-entry-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const entryId = e.currentTarget.dataset.id;
                deleteEntry(entryId);
            });
        });
    }

    function createEntryHtml(entry) {
        const moodEmoji = MOOD_EMOJIS[entry.mood] || '‚ùì';
        const moodName = window.MOOD_NAMES[entry.mood] || 'Unbekannt';
        const painDisplay = entry.pain !== undefined && entry.pain !== null 
                             ? `<span class="text-purple-600 font-bold ml-2">Schmerz: ${entry.pain}/10</span>`
                             : '';
        const painRegions = entry.schmerzRegionen && entry.schmerzRegionen.length > 0
                             ? `<span class="text-xs font-medium text-purple-500 ml-3 bg-purple-100 px-2 py-0.5 rounded-full">${entry.schmerzRegionen.map(r => PAIN_REGION_NAMES[r] || r).join(', ')}</span>`
                             : '';
        
        let vitalData = [];
        if (entry.puls !== undefined && entry.puls !== null) vitalData.push(`Puls: ${entry.puls} BPM`);
        if (entry.gewicht !== undefined && entry.gewicht !== null) vitalData.push(`Gewicht: ${entry.gewicht} kg`);
        if (entry.bmi !== undefined && entry.bmi !== null && entry.bmi !== 'N/A') vitalData.push(`BMI: ${entry.bmi}`); 
        if (entry.blutzucker !== undefined && entry.blutzucker !== null) vitalData.push(`BZ: ${entry.blutzucker} mg/dL`);
        if (entry.blutdruckSys !== undefined && entry.blutdruckSys !== null && entry.blutdruckDia !== undefined && entry.blutdruckDia !== null) {
             vitalData.push(`RR: ${entry.blutdruckSys}/${entry.blutdruckDia} mmHg`);
        }
        
        const alterDisplay = entry.alter !== undefined && entry.alter !== null
                            ? `<span class="text-xs font-medium text-gray-500 ml-3">Alter: ${entry.alter}</span>`
                            : '';
        
        const vitalLine = vitalData.length > 0 
                            ? `<p class="text-xs text-yellow-700 font-medium mt-1 flex items-center">${vitalData.join(' ¬∑ ')}${alterDisplay}</p>` 
                            : '';

        let weatherLine = '';
        if (entry.temperature !== undefined && entry.temperature !== null) { weatherLine += `${entry.temperature}¬∞C`; }
        if (entry.weatherCondition) {
             if (weatherLine) weatherLine += ' ¬∑ ';
             weatherLine += entry.weatherCondition;
        }

        return `
            <div class="flex py-3 px-4 bg-white border-b border-gray-100 last:border-b-0 history-entry-item">
                <div class="flex items-start space-x-3 w-full">
                    <span class="flex-shrink-0 text-xl font-bold text-indigo-500">${entry.timePeriod}</span>
                    <div class="flex-shrink-0 text-3xl">${moodEmoji}</div>
                    <div class="text-sm flex-grow min-w-0">
                        <p class="font-semibold text-gray-700 flex items-center flex-wrap">
                            ${moodName}${painDisplay}${painRegions}
                        </p>
                        ${vitalLine}
                        ${entry.note || weatherLine ? 
                            `<p class="text-gray-500 italic text-xs mt-1 break-words">${entry.note ? entry.note + (weatherLine ? ' | ' : '') : ''}${weatherLine}</p>` 
                        : ''}
                    </div>
                </div>
                <button class="delete-entry-btn hover:text-red-600" data-id="${entry.id}" title="Eintrag l√∂schen">
                    &times;
                </button>
            </div>
        `;
    }

    function deleteEntry(id) {
        if (!confirm(`Sicher, dass Sie diesen Eintrag (ID: ${id}) l√∂schen m√∂chten?`)) { return; }
        const initialLength = allStoredEntries.length;
        allStoredEntries = allStoredEntries.filter(entry => entry.id !== id);
        if (allStoredEntries.length < initialLength) {
            saveEntriesToLocalStorage(allStoredEntries);
            renderSortedHistory(allStoredEntries, true);
        } else {
            alert("Fehler: Eintrag nicht gefunden.");
        }
    }

    function resetData() {
        if (!confirm("WARNUNG! Sind Sie sicher, dass Sie ALLE Eintr√§ge l√∂schen m√∂chten? Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!")) { return; }
        
        if (confirm("Sollen auch Ihre dauerhaft gespeicherten Vitaldaten (Geburtsdatum und Gr√∂√üe) gel√∂scht werden?")) {
            try {
                localStorage.removeItem(getUserVitalInfoKey()); 
                userVitalInfo = {};
            } catch (e) {
                 console.error("Fehler beim L√∂schen der Benutzer-Vitaldaten:", e);
            }
        }

        resetButton.disabled = true;
        resetStatusEl.textContent = 'L√∂sche alle Daten...';
        resetStatusEl.className = 'mt-3 text-center text-sm font-medium text-yellow-600 h-4';
        try {
            localStorage.removeItem(getLocalStorageKey()); 
            allStoredEntries = []; 
            resetStatusEl.textContent = `Erfolgreich alle Eintr√§ge f√ºr Benutzer "${activeUser}" gel√∂scht!`;
            resetStatusEl.className = 'mt-3 text-center text-sm font-medium text-green-600 h-4';
            yearFilterEl.value = 'all';
            monthFilterEl.value = 'all';
            renderSortedHistory([], true); 
            setupApp(); 
        } catch (error) {
            console.error("Fehler beim L√∂schen der Eintr√§ge:", error);
            resetStatusEl.textContent = 'Fehler beim L√∂schen.';
            resetStatusEl.className = 'mt-3 text-center text-sm font-medium text-red-600 h-4';
        } finally {
            resetButton.disabled = false;
            setTimeout(() => { resetStatusEl.textContent = ''; }, 3000);
        }
    }
    
    function exportData() {
        const allEntries = allStoredEntries;
        const exportObject = {
            activeUser: activeUser, 
            entries: allEntries,
            userVitalInfo: userVitalInfo,
            
            userList: getSavedUsers() 
        };

        if (allEntries.length === 0 && Object.keys(userVitalInfo).length === 0) { 
            alert("Es sind keine Eintr√§ge oder Benutzerdaten zum Exportieren vorhanden!"); 
            return; 
        }

        const dataStr = JSON.stringify(exportObject, null, 2); 
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const filename = `stimmungs_backup_${activeUser}_${now.toISOString().split('T')[0]}.json`;
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importData() {
        const file = jsonFileInput.files[0];
        if (!file) { alert("Bitte w√§hlen Sie eine JSON-Datei aus."); return; }
        importButton.disabled = true;
        importStatusEl.textContent = 'Importiere...';
        importStatusEl.className = 'mt-3 text-center text-sm font-medium text-blue-600 h-4';
        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                let importedEntries = [];
                let importedUserVitalInfo = {};
                let importedUserList = getSavedUsers();
                let targetUser = activeUser;

                if (importedData.entries && Array.isArray(importedData.entries)) {

                    importedEntries = importedData.entries;
                    importedUserVitalInfo = importedData.userVitalInfo || {};
                    if (importedData.activeUser) { targetUser = importedData.activeUser; }
                    if (importedData.userList && Array.isArray(importedData.userList)) {
                        importedUserList = [...new Set([...importedUserList, ...importedData.userList])];
                        saveUsers(importedUserList);
                    }
                } else if (Array.isArray(importedData)) { 

                    importedEntries = importedData;
                } else {
                     throw new Error("Die Datei ist kein g√ºltiges Backup-Format. Erwartet wurde ein JSON-Array ([...]) oder ein Objekt mit dem Schl√ºssel 'entries'."); 
                }

                if (targetUser !== activeUser) {
                    if (!confirm(`Die Backup-Datei scheint f√ºr den Benutzer "${targetUser}" zu sein. M√∂chten Sie zum Benutzer wechseln, um die Daten zu importieren? Andernfalls werden sie in den aktiven Benutzer ("${activeUser}") importiert.`)) {
                         targetUser = activeUser;
                    } else {
                        switchToUser(targetUser); 
                        return;
                    }
                }


                let entriesAdded = 0;
                let entriesOverwritten = 0;

                
                importedEntries.forEach(entry => {
                    const docId = entry.date + '_' + entry.timePeriod;
                    entry.id = docId; 
                    entry.schmerzRegionen = Array.isArray(entry.schmerzRegionen) ? entry.schmerzRegionen : [];
                    
                    if (entry.geburtsdatum === undefined && importedUserVitalInfo.geburtsdatum) {
                        entry.geburtsdatum = importedUserVitalInfo.geburtsdatum;
                        entry.alter = calculateAge(entry.geburtsdatum);
                    }
                    if (entry.koerpergroesse === undefined && importedUserVitalInfo.koerpergroesse) {
                        entry.koerpergroesse = importedUserVitalInfo.koerpergroesse;
                    }
                    if (entry.bmi === undefined) {
                        entry.bmi = calculateBMI(entry.gewicht, entry.koerpergroesse);
                    }

                    const existingIndex = allStoredEntries.findIndex(e => e.id === docId);
                    if (existingIndex > -1) {
                        allStoredEntries[existingIndex] = entry;
                        entriesOverwritten++;
                    } else {
                        allStoredEntries.push(entry);
                        entriesAdded++;
                    }
                });
                
                
                if (importedUserVitalInfo.geburtsdatum || importedUserVitalInfo.koerpergroesse) {
                    saveUserVitalInfo(
                        importedUserVitalInfo.geburtsdatum || userVitalInfo.geburtsdatum || null,
                        importedUserVitalInfo.koerpergroesse || userVitalInfo.koerpergroesse || null
                    );
                }


                saveEntriesToLocalStorage(allStoredEntries);
                yearFilterEl.value = 'all';
                monthFilterEl.value = 'all';
                
                setupApp(); 
                
                importStatusEl.textContent = `Import erfolgreich f√ºr Benutzer "${activeUser}"! ${entriesAdded} neu, ${entriesOverwritten} √ºberschrieben.`;
                importStatusEl.className = 'mt-3 text-center text-sm font-medium text-green-600 h-4';
            } catch (error) {
                console.error("Fehler beim Importieren oder Parsen:", error);
                importStatusEl.textContent = `Importfehler: ${error.message}`;
                importStatusEl.className = 'mt-3 text-center text-sm font-medium text-red-600 h-4';
            } finally {
                importButton.disabled = false;
                jsonFileInput.value = ''; 
            }
        };

        reader.onerror = function() {
            importStatusEl.textContent = 'Fehler beim Lesen der Datei.';
            importStatusEl.className = 'mt-3 text-center text-sm font-medium text-red-600 h-4';
            importButton.disabled = false;
        };

        reader.readAsText(file);
    }

    function formatDate(dateString) {
        try {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(Date.UTC(year, month - 1, day)); 
            return date.toLocaleDateString('de-DE', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        } catch (e) {
            return dateString;
        }
    }

    window.formatDateShort = function(dateString) {
        try {
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(Date.UTC(year, month - 1, day)); 
            return date.toLocaleDateString('de-DE', { 
                weekday: 'short', day: 'numeric', month: 'short' 
            }).replace(/\./g, '').trim(); 
        } catch (e) {
            return dateString;
        }
    }

    let moodChartInstance = null;
    const chartStatusEl = document.getElementById('chart-status');
    const moodChartEl = document.getElementById('moodChart'); 
    const chartContainerEl = document.getElementById('chart-container'); 
    let painRegionChartInstance = null;
    const painRegionChartEl = document.getElementById('painRegionChart');
    const painChartStatusEl = document.getElementById('pain-chart-status');
    let vitalChartInstance = null;
    const vitalChartEl = document.getElementById('vitalChart');
    const vitalChartStatusEl = document.getElementById('vital-chart-status');
    const vitalChartContainerEl = document.getElementById('vital-chart-container');

    const TEMP_MIN = -5;  
    const TEMP_MAX = 25;  
    const TEMP_RANGE = TEMP_MAX - TEMP_MIN; 

    function normalizeTemperature(temp) {
        if (temp === null || temp === undefined) return null;
        if (TEMP_RANGE === 0) return 5; 
        let clampedTemp = Math.max(TEMP_MIN, Math.min(TEMP_MAX, temp)); 
        return ((clampedTemp - TEMP_MIN) / TEMP_RANGE) * 10;
    }

    function denormalizeTemperature(normalizedValue) {
        if (normalizedValue === null || normalizedValue === undefined) return null;
        return (normalizedValue / 10 * TEMP_RANGE) + TEMP_MIN;
    }

    function renderMoodChart(entries) {
        if (typeof Chart === 'undefined') { console.error("Chart.js ist nicht geladen."); return; }
        if (moodChartInstance) { moodChartInstance.destroy(); }
        
        const dataToUse = allStoredEntries; 
        const dailyData = dataToUse.reduce((acc, entry) => {
            const dateKey = entry.date;
            const moodValue = window.MOOD_VALUES[entry.mood] || 3; 
            const tempValue = entry.temperature || null; 
            const painValue = entry.pain; 
            
            if (!acc[dateKey]) { acc[dateKey] = { moodSum: 0, moodCount: 0, tempSum: 0, tempCount: 0, painSum: 0, painCount: 0 }; }
            
            acc[dateKey].moodSum += moodValue;
            acc[dateKey].moodCount++;
            if (tempValue !== null) { acc[dateKey].tempSum += tempValue; acc[dateKey].tempCount++; }
            if (painValue !== undefined && painValue !== null) { acc[dateKey].painSum += painValue; acc[dateKey].painCount++; }
            return acc;
        }, {});

        const sortedDates = Object.keys(dailyData).sort();
        const chartData = sortedDates.map(date => {
            const data = dailyData[date];
            const averageTempOriginal = data.tempCount > 0 ? data.tempSum / data.tempCount : null;
            return {
                date: date,
                averageMood: data.moodCount > 0 ? data.moodSum / data.moodCount : null,
                averageTempNormalized: normalizeTemperature(averageTempOriginal),
                averagePain: data.painCount > 0 ? data.painSum / data.painCount : null, 
                averageTempOriginal: averageTempOriginal 
            };
        });

        if (chartData.length < 2) {
            chartStatusEl.classList.remove('hidden');
            moodChartEl.style.width = '100%'; 
            exportChartButton.disabled = true;
            return;
        }
        chartStatusEl.classList.add('hidden');
        exportChartButton.disabled = false;

        const numDataPoints = chartData.length;
        const PIXELS_PER_DATA_POINT = 60; 
        const calculatedWidth = numDataPoints * PIXELS_PER_DATA_POINT;
        let finalChartWidth = Math.max(400, calculatedWidth); 
        moodChartEl.style.width = `${finalChartWidth}px`;
        moodChartEl.height = 256; 

        const ctx = moodChartEl.getContext('2d');
        const labels = chartData.map(d => window.formatDateShort(d.date)); 
        const moodData = chartData.map(d => d.averageMood);
        const tempDataNormalized = chartData.map(d => d.averageTempNormalized);
        const painData = chartData.map(d => d.averagePain); 
        
        moodChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '√ò Stimmung (1-5)',
                        data: moodData,
                        borderColor: '#4f46e5', 
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#4f46e5',
                        yAxisID: 'mood', 
                        order: 1,
                    },
                    {
                        label: '√ò Schmerz (0-10)', 
                        data: painData,
                        borderColor: '#9333ea', 
                        backgroundColor: 'rgba(147, 51, 234, 0.3)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#9333ea',
                        yAxisID: 'pain', 
                        type: 'line', 
                        order: 3, 
                    },
                    {
                        label: '√ò Temperatur (Skaliert)', 
                        data: tempDataNormalized, 
                        borderColor: '#ef4444', 
                        backgroundColor: 'rgba(239, 68, 68, 0.4)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 5,
                        pointBackgroundColor: '#ef4444',
                        yAxisID: 'pain', 
                        type: 'line', 
                        order: 2,
                    }
                ]
            },
            options: {
                responsive: false, 
                maintainAspectRatio: false, 
                scales: {
                    mood: {
                        type: 'linear',
                        position: 'left',
                        min: 1, max: 5, stepSize: 1,
                        title: { display: true, text: 'Stimmungswert' },
                        ticks: {
                            color: '#4f46e5',
                            callback: function(value) {
                                const moodName = Object.keys(window.MOOD_VALUES).find(key => window.MOOD_VALUES[key] === value);
                                return moodName ? window.MOOD_NAMES[moodName] : value;
                            }
                        }
                    },
                    pain: { 
                        type: 'linear', position: 'right', id: 'pain', min: 0, max: 10, stepSize: 1, 
                        grid: { drawOnChartArea: false },
                        title: { display: false },
                        ticks: {
                            color: '#9333ea', 
                            callback: function(value) { return value.toFixed(0); },
                            padding: 30, 
                        }
                    },
                    temp_ref: { 
                        type: 'linear', position: 'right', id: 'temp_ref', min: 0, max: 10, stepSize: 1, 
                        grid: { drawOnChartArea: false, borderColor: 'transparent', drawTicks: false },
                        title: { display: false },
                        ticks: {
                            color: '#ef4444', 
                            callback: function(value) {
                                const tempValue = denormalizeTemperature(value);
                                return `(‚âà${tempValue.toFixed(1)}¬∞C)`; 
                            },
                            padding: 0, 
                        }
                    },
                    x: { beginAtZero: false, }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.dataset.yAxisID === 'mood') {
                                    const value = context.parsed.y;
                                    const mood = Object.keys(window.MOOD_VALUES).find(key => window.MOOD_VALUES[key] === Math.round(value));
                                    label += `${value.toFixed(2)} (${mood ? window.MOOD_NAMES[mood] : 'N/A'})`; 
                                } else if (context.dataset.label.includes('Schmerz')) { 
                                    label += `${context.parsed.y.toFixed(1)}/10`;
                                } else if (context.dataset.label.includes('Temperatur')) { 
                                    const normalized = context.parsed.y;
                                    const actualTemp = denormalizeTemperature(normalized);
                                    label = `√ò Temperatur: ${actualTemp.toFixed(1)}¬∞C`; 
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        chartContainerEl.scrollLeft = chartContainerEl.scrollWidth;
    }

    function renderVitalChart(entries) {
        if (typeof Chart === 'undefined') { console.error("Chart.js ist nicht geladen."); return; }
        if (vitalChartInstance) { vitalChartInstance.destroy(); }

        const dailyData = entries.reduce((acc, entry) => {
            const dateKey = entry.date;
            if (!acc[dateKey]) { 
                acc[dateKey] = {
                    pulsSum: 0, pulsCount: 0,
                    gewichtSum: 0, gewichtCount: 0,
                    blutzuckerSum: 0, blutzuckerCount: 0,
                    blutdruckSysSum: 0, blutdruckSysCount: 0,
                    blutdruckDiaSum: 0, blutdruckDiaCount: 0,
                    bmiSum: 0, bmiCount: 0,
                }; 
            }
            if (entry.puls !== null) { acc[dateKey].pulsSum += entry.puls; acc[dateKey].pulsCount++; }
            if (entry.gewicht !== null) { acc[dateKey].gewichtSum += entry.gewicht; acc[dateKey].gewichtCount++; }
            if (entry.blutzucker !== null) { acc[dateKey].blutzuckerSum += entry.blutzucker; acc[dateKey].blutzuckerCount++; }
            if (entry.blutdruckSys !== null) { acc[dateKey].blutdruckSysSum += entry.blutdruckSys; acc[dateKey].blutdruckSysCount++; }
            if (entry.blutdruckDia !== null) { acc[dateKey].blutdruckDiaSum += entry.blutdruckDia; acc[dateKey].blutdruckDiaCount++; }
            if (entry.bmi !== null && entry.bmi !== 'N/A' && !isNaN(parseFloat(entry.bmi))) {
                acc[dateKey].bmiSum += parseFloat(entry.bmi);
                acc[dateKey].bmiCount++;
            }
            return acc;
        }, {});

        const sortedDates = Object.keys(dailyData).sort();
        const chartData = sortedDates.map(date => {
            const data = dailyData[date];
            return {
                date: date,
                puls: data.pulsCount > 0 ? data.pulsSum / data.pulsCount : null,
                gewicht: data.gewichtCount > 0 ? data.gewichtSum / data.gewichtCount : null,
                blutzucker: data.blutzuckerCount > 0 ? data.blutzuckerSum / data.blutzuckerCount : null,
                blutdruckSys: data.blutdruckSysCount > 0 ? data.blutdruckSysSum / data.blutdruckSysCount : null,
                blutdruckDia: data.blutdruckDiaCount > 0 ? data.blutdruckDiaSum / data.blutdruckDiaCount : null,
                bmi: data.bmiCount > 0 ? data.bmiSum / data.bmiCount : null, 
            };
        });

        const hasVitalData = chartData.some(d => d.puls || d.gewicht || d.blutzucker || d.blutdruckSys || d.blutdruckDia || d.bmi); 

        if (!hasVitalData) {
            vitalChartStatusEl.classList.remove('hidden');
            vitalChartEl.style.width = '100%';
            exportVitalChartButton.disabled = true;
            return;
        }
        vitalChartStatusEl.classList.add('hidden');
        exportVitalChartButton.disabled = false;

        const numDataPoints = chartData.length;
        const PIXELS_PER_DATA_POINT = 60; 
        const calculatedWidth = numDataPoints * PIXELS_PER_DATA_POINT;
        let finalChartWidth = Math.max(400, calculatedWidth); 
        vitalChartEl.style.width = `${finalChartWidth}px`;
        vitalChartEl.height = 256; 

        const ctx = vitalChartEl.getContext('2d');
        const labels = chartData.map(d => window.formatDateShort(d.date)); 

        const PULS_COLOR_CHART = '#10b981';   
        const GEWICHT_COLOR_CHART = '#db2777'; 
        const BLUTZUCKER_COLOR_CHART = '#d97706'; 
        const BLUTDRUCK_SYS_COLOR_CHART = '#06b6d4'; 
        const BLUTDRUCK_DIA_COLOR_CHART = '#60a5fa'; 
        const BMI_COLOR_CHART = '#4f46e5'; 

        const bmiValues = chartData.map(d => d.bmi).filter(v => v !== null);
        const bmiMin = bmiValues.length > 0 ? Math.floor(Math.min(...bmiValues) - 2) : 15;
        const bmiMax = bmiValues.length > 0 ? Math.ceil(Math.max(...bmiValues) + 2) : 35;
        const gewichtValues = chartData.map(d => d.gewicht).filter(v => v !== null);
        const gewichtMin = gewichtValues.length > 0 ? Math.floor(Math.min(...gewichtValues) / 5) * 5 : 50;
        const gewichtMax = gewichtValues.length > 0 ? Math.ceil(Math.max(...gewichtValues) / 5) * 5 : 100;
        
        vitalChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '√ò Puls (BPM)',
                        data: chartData.map(d => d.puls),
                        borderColor: PULS_COLOR_CHART, 
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 2, tension: 0.3, pointRadius: 4, yAxisID: 'puls', order: 1,
                    },
                    {
                        label: '√ò Blutzucker (mg/dL)',
                        data: chartData.map(d => d.blutzucker),
                        borderColor: BLUTZUCKER_COLOR_CHART, 
                        backgroundColor: 'rgba(217, 119, 6, 0.2)', 
                        borderWidth: 2, tension: 0.3, pointRadius: 4, yAxisID: 'blutzucker', order: 3,
                    },
                    {
                        label: '√ò Blutdruck Systolisch (mmHg)',
                        data: chartData.map(d => d.blutdruckSys),
                        borderColor: BLUTDRUCK_SYS_COLOR_CHART, 
                        backgroundColor: 'rgba(6, 182, 212, 0.2)',
                        borderWidth: 2, tension: 0.3, pointRadius: 4, yAxisID: 'blutdruck', order: 4,
                    },
                    {
                        label: '√ò Blutdruck Diastolisch (mmHg)',
                        data: chartData.map(d => d.blutdruckDia),
                        borderColor: BLUTDRUCK_DIA_COLOR_CHART, 
                        backgroundColor: 'rgba(96, 165, 250, 0.2)',
                        borderWidth: 2, tension: 0.3, pointRadius: 4, yAxisID: 'blutdruck', order: 5,
                    },
                    {
                        label: '√ò BMI',
                        data: chartData.map(d => d.bmi),
                        borderColor: BMI_COLOR_CHART,
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        borderWidth: 3, tension: 0.3, pointRadius: 5, yAxisID: 'bmi', order: 6,
                    },
                    {
                        label: '√ò Gewicht (kg)',
                        data: chartData.map(d => d.gewicht),
                        borderColor: GEWICHT_COLOR_CHART, 
                        backgroundColor: 'rgba(219, 39, 119, 0.2)', 
                        borderWidth: 2, tension: 0.3, pointRadius: 4, yAxisID: 'gewicht', order: 2,
                    },
                ]
            },
            options: {
                responsive: false, 
                maintainAspectRatio: false, 
                scales: {
                    puls: { type: 'linear', position: 'left', min: 40, max: 120, title: { display: true, text: 'Puls (BPM)', color: PULS_COLOR_CHART }, ticks: { color: PULS_COLOR_CHART, callback: (v) => v.toFixed(0) } },
                    gewicht: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, min: 50, max: 100, title: { display: true, text: 'Gewicht (kg)', color: GEWICHT_COLOR_CHART }, ticks: { color: GEWICHT_COLOR_CHART, callback: (v) => v.toFixed(1) } },
                    blutzucker: { type: 'linear', position: 'left', grid: { drawOnChartArea: false }, min: 70, max: 200, title: { display: true, text: 'Blutzucker (mg/dL)', color: BLUTZUCKER_COLOR_CHART }, ticks: { color: BLUTZUCKER_COLOR_CHART, callback: (v) => v.toFixed(0) } },
                    blutdruck: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, min: 50, max: 180, title: { display: true, text: 'Blutdruck (mmHg)', color: BLUTDRUCK_SYS_COLOR_CHART }, ticks: { color: BLUTDRUCK_SYS_COLOR_CHART, callback: (v) => v.toFixed(0) } },
                    bmi: {
                        type: 'linear', position: 'right', grid: { drawOnChartArea: false }, 
                        min: bmiMin, max: bmiMax,
                        title: { display: true, text: 'BMI', color: BMI_COLOR_CHART }, ticks: { color: BMI_COLOR_CHART, callback: (v) => v.toFixed(1) }
                    },
                    x: { beginAtZero: false, }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    if (context.dataset.label.includes('Gewicht')) return label + `${context.parsed.y.toFixed(1)} kg`;
                                    if (context.dataset.label.includes('Blutzucker')) return label + `${context.parsed.y.toFixed(0)} mg/dL`;
                                    if (context.dataset.label.includes('Puls')) return label + `${context.parsed.y.toFixed(0)} BPM`;
                                    if (context.dataset.label.includes('Blutdruck')) return label + `${context.parsed.y.toFixed(0)} mmHg`;
                                    if (context.dataset.label.includes('BMI')) return label + `${context.parsed.y.toFixed(1)}`; 
                                }
                                return label + 'N/A';
                            }
                        }
                    }
                }
            }
        });

        vitalChartContainerEl.scrollLeft = vitalChartContainerEl.scrollWidth;
    }

    function renderPainRegionChart(entries) {
        if (typeof Chart === 'undefined') { console.error("Chart.js ist nicht geladen."); return; }
        if (painRegionChartInstance) { painRegionChartInstance.destroy(); }
        
        const dataToUse = allStoredEntries; 
        const regionCounts = { 'oben': 0, 'mitte': 0, 'unten': 0 };
        let totalCount = 0;

        dataToUse.forEach(entry => {
            if (entry.schmerzRegionen && Array.isArray(entry.schmerzRegionen)) {
                entry.schmerzRegionen.forEach(region => {
                    if (regionCounts.hasOwnProperty(region)) {
                        regionCounts[region]++;
                        totalCount++;
                    }
                });
            }
        });
        
        if (totalCount === 0) {
            painChartStatusEl.classList.remove('hidden');
            exportPainChartButton.disabled = true;
            return;
        }
        painChartStatusEl.classList.add('hidden');
        exportPainChartButton.disabled = false;

        const labels = Object.keys(regionCounts).map(key => PAIN_REGION_NAMES[key]);
        const data = Object.values(regionCounts);
        
        const backgroundColors = [
            'rgba(147, 51, 234, 0.8)', 
            'rgba(192, 132, 252, 0.8)', 
            'rgba(233, 213, 255, 0.8)' 
        ];
        
        const borderColors = [
            'rgb(147, 51, 234)',
            'rgb(192, 132, 252)',
            'rgb(233, 213, 255)'
        ];

        const ctx = painRegionChartEl.getContext('2d');
        painRegionChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'H√§ufigkeit der Schmerzregionen',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 20 }
                    },
                    title: {
                        display: true,
                        text: `Gesamte Schmerzereignisse: ${totalCount}`,
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const count = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0); 
                                const percentage = total === 0 ? '0.0%' : ((count / total) * 100).toFixed(1) + '%';
                                
                                return `${context.label}: ${count} mal (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }

    setupFormListeners(); 
    setupApp(); 
</script>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker-Registrierung erfolgreich:', registration);
          })
          .catch(err => {
            console.error('ServiceWorker-Registrierung fehlgeschlagen:', err);
          });
      });
    }
</script>
</body>
</html>
